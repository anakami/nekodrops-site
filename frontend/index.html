<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEKO DROPS</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    .connection-status {
      position: fixed; top: 10px; right: 10px;
      padding: 8px 12px; border-radius: 20px;
      font-weight: bold; z-index: 1000;
      font-size: 12px; background: #f44336; color: white;
    }
    .connection-status.connected { background: #4CAF50; }
  </style>
</head>
<body>
  <div id="connection-status" class="connection-status">‚ùå Desconectado</div>

  <div class="container">
    <header>
      <div class="logo">NEKO <span>DROPS</span></div>
      <button class="mobile-menu-btn">‚ò∞</button>
      <div class="auth-section">
        <div id="user-info" class="user-info hidden">
          <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
          <span id="username"></span>
        </div>
        <button id="login-btn" class="login-btn">Entrar com Discord</button>
      </div>
    </header>

    <div class="filters">
      <button class="filter-btn active" data-filter="all">Todas as Contas</button>
      <button class="filter-btn" data-filter="normal">Contas Normais</button>
      <button class="filter-btn" data-filter="vip">Contas VIP</button>
    </div>

    <div id="drops-container">
      <div class="drops-grid" id="drops-grid">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://nekodrops-backend.onrender.com';
    const VIP_ROLE_ID = "1399662852448587859";
    const OWNER_ROLE_ID = "1399664650638856303";

    const dropsGrid = document.getElementById('drops-grid');
    const connectionStatus = document.getElementById('connection-status');
    let user = null, userRoles = [], drops = [], socket = null;

    function cleanDiscordText(text) {
      if (!text) return "";
      return text.replace(/```/g, "").trim();
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupWebSocket();
      loadDrops();
    });

    function setupWebSocket() {
      socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });
      socket.on('connect', () => {
        connectionStatus.textContent = '‚úÖ Conectado';
        connectionStatus.classList.add('connected');
      });
      socket.on('disconnect', () => {
        connectionStatus.textContent = '‚ùå Desconectado';
        connectionStatus.classList.remove('connected');
      });
      socket.on('new-drop', dropData => { drops.unshift(dropData); renderDrops(); });
      socket.on('drop-deleted', id => { drops = drops.filter(d => d.id !== id); renderDrops(); });
    }

    async function loadDrops() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/drops`);
        const data = await res.json();
        drops = data.success ? data.drops : [];
      } catch { drops = []; }
      renderDrops();
    }

    function renderDrops(filter = 'all') {
      clearDrops();
      if (!drops.length) {
        dropsGrid.innerHTML = `<div class="no-drops"><h3>Nenhuma conta dispon√≠vel</h3></div>`;
        return;
      }
      drops.forEach(d => dropsGrid.appendChild(createRobloxAccountElement(d, true)));
    }

    function createRobloxAccountElement(account, isOwner) {
      const card = document.createElement('div');
      card.className = 'drop-card'; card.dataset.id = account.id;

      const username = cleanDiscordText(account.username) || "Conta Roblox";
      const password = cleanDiscordText(account.password) || "";
      const cookie = cleanDiscordText(account.cookie) || "";
      const ip = cleanDiscordText(account.ip) || "";
      const auth = cleanDiscordText(account.authenticator) || "";
      const recovery = cleanDiscordText(account.recovery) || "";

      // üîπ Detecta o tipo de embed
      let type = "";
      if (auth) type = "auth";
      else if (cookie && ip) type = "cookie";
      else if (ip) type = "ip";

      let credentialsHTML = `
        <div class="credential-item">
          <span>Usu√°rio: </span><span class="credential-value">${username}</span>
          <button class="copy-btn" data-value="${username}">Copiar</button>
        </div>
        ${password ? `
        <div class="credential-item">
          <span>Senha: </span><span class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
          <button class="copy-btn" data-value="${password}">Copiar</button>
        </div>` : ""}
      `;

      if (type === "cookie") {
        credentialsHTML += `
          <div class="credential-item">
            <span>IP: </span><span class="credential-value">${ip}</span>
            <button class="copy-btn" data-value="${ip}">Copiar</button>
          </div>
          <div class="credential-item">
            <span>Cookie: </span><span class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button class="copy-btn" data-value="${cookie}">Copiar</button>
          </div>`;
      }

      if (type === "auth") {
        credentialsHTML += `
          <div class="credential-item">
            <span>Auth: </span><span class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button class="copy-btn" data-value="${auth}">Copiar</button>
          </div>
          ${recovery ? `
          <div class="credential-item">
            <span>Recovery Codes: </span><span class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button class="copy-btn" data-value="${recovery}">Copiar</button>
          </div>` : ""}
          <div class="credential-item">
            <span>Cookie: </span><span class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button class="copy-btn" data-value="${cookie}">Copiar</button>
          </div>`;
      }

      if (type === "ip") {
        credentialsHTML += `
          <div class="credential-item">
            <span>IP: </span><span class="credential-value">${ip}</span>
            <button class="copy-btn" data-value="${ip}">Copiar</button>
          </div>`;
      }

      card.innerHTML = `
        <div class="drop-badge">ROBLOX</div>
        <div class="drop-content">
          <h3 class="drop-title">${username}</h3>
          <div class="account-credentials">${credentialsHTML}</div>
          <div class="drop-footer">
            <button class="claim-btn">Resgatar Agora</button>
            ${isOwner ? '<button class="delete-btn">üóëÔ∏è</button>' : ''}
          </div>
        </div>
      `;

      if (isOwner) {
        const del = card.querySelector('.delete-btn');
        del.addEventListener('click', () => {
          if (confirm(`Deletar \"${username}\"?`)) deleteDrop(account.id);
        });
      }

      return card;
    }

    async function deleteDrop(id) {
      try {
        await fetch(`${BACKEND_URL}/api/drops/${id}`, { method: 'DELETE' });
        drops = drops.filter(d => d.id !== id); renderDrops();
      } catch { alert("Erro ao deletar"); }
    }

    function clearDrops() { dropsGrid.innerHTML = ''; }
  </script>
</body>
</html>
