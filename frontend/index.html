<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEKO DROPS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="style.css">
    <!-- Socket.io CDN para WebSocket -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* Estilos adicionais para WebSocket */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            font-size: 12px;
            background: #f44336;
            color: white;
        }
        
        .connection-status.connected {
            background: #4CAF50;
        }
        
        .drop-notification {
            position: fixed;
            top: 50px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 999;
            max-width: 250px;
            font-size: 14px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Status de conex√£o WebSocket -->
    <div id="connection-status" class="connection-status">
        ‚ùå Desconectado
    </div>

    <div class="container">
        <header>
            <div class="logo">NEKO <span>DROPS</span></div>
            <button class="mobile-menu-btn">‚ò∞</button>
            <div class="auth-section">
                <div id="user-info" class="user-info hidden">
                    <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
                    <span id="username"></span>
                </div>
                <button id="login-btn" class="login-btn">Entrar com Discord</button>
            </div>
        </header>
        
        <div class="filters">
            <button class="filter-btn active" data-filter="all">Todas as Contas</button>
            <button class="filter-btn" data-filter="normal">Contas Normais</button>
            <button class="filter-btn" data-filter="vip">Contas VIP</button>
        </div>
        
        <div id="drops-container">
            <div class="drops-grid" id="drops-grid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Entrar com Discord</h2>
            <p>Para acessar as contas, voc√™ precisa fazer login com sua conta do Discord e ser membro do nosso servidor.</p>
            <button id="modal-login-btn" class="modal-btn">Continuar com Discord</button>
        </div>
    </div>

    <div id="error-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Erro de Acesso</h2>
            <p id="error-message">Voc√™ precisa ser membro do servidor para acessar as contas.</p>
            <button class="modal-btn" id="error-close-btn">Fechar</button>
        </div>
    </div>

    <script>
        // Configura√ß√µes - URLs do backend no Render
        const CLIENT_ID = "1410654667490197641";
        const REDIRECT_URI = "https://nekodrops-site.onrender.com/";
        const SERVER_ID = "1399661543284805763";
        const MEMBER_ROLE_ID = "1399662113114296360";
        const VIP_ROLE_ID = "1399662852448587859";
        const OWNER_ROLE_ID = "1399664650638856303";

        // URL do backend - Render
        const BACKEND_URL = 'https://nekodrops-backend.onrender.com';

        // Elementos DOM
        const loginBtn = document.getElementById('login-btn');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const username = document.getElementById('username');
        const dropsGrid = document.getElementById('drops-grid');
        const loginModal = document.getElementById('login-modal');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const errorCloseBtn = document.getElementById('error-close-btn');
        const modalLoginBtn = document.getElementById('modal-login-btn');
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const filters = document.querySelector('.filters');
        const connectionStatus = document.getElementById('connection-status');

        // Estado da aplica√ß√£o
        let user = null;
        let userRoles = [];
        let drops = [];
        let socket = null;

        // Dados de exemplo de contas Roblox
        const sampleRobloxAccounts = [
            {
                id: 1,
                messageId: "123456789",
                username: "Ethchacoc",
                password: "Lok1_3008'",
                ip: "91.173.167.33",
                robux: "0",
                premium: false,
                cookie: "COOKIE_ROBLOX_AQUI",
                age: "1109 Dias",
                status: "Unverified (No Email Address)",
                description: "Conta Roblox com 1109 dias de idade. Ideal para quem busca uma conta estabelecida.",
                features: [
                    "Idade: 1109 Dias",
                    "Status: N√£o verificado",
                    "IP: 91.173.167.33",
                    "Robux: 0",
                    "Premium: N√£o"
                ],
                imageUrl: "https://via.placeholder.com/300x160/5865F2/FFFFFF?text=Roblox+Account",
                isVip: false,
                createdAt: "2023-11-15T10:30:00Z"
            },
            {
                id: 2,
                messageId: "987654321",
                username: "VIP_Account",
                password: "V1P_P@ssw0rd",
                ip: "192.168.1.1",
                robux: "5000",
                premium: true,
                cookie: "VIP_COOKIE_ROBLOX",
                age: "500 Dias",
                status: "Verified",
                description: "Conta Roblox VIP com 5000 Robux e assinatura Premium.",
                features: [
                    "Idade: 500 Dias",
                    "Status: Verificado",
                    "IP: 192.168.1.1",
                    "Robux: 5000",
                    "Premium: Sim"
                ],
                imageUrl: "https://via.placeholder.com/300x160/FFD700/000000?text=VIP+Account",
                isVip: true,
                createdAt: "2023-10-01T14:20:00Z"
            }
        ];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
            setupFilters();
            setupCopyButtons();
            setupModalClosing();
            setupMobileMenu();
            processAuthResponse();
            setupWebSocket(); // Inicializar WebSocket
        });

        // Configurar WebSocket
        function setupWebSocket() {
            try {
                socket = io(BACKEND_URL, {
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    console.log('‚úÖ Conectado ao WebSocket');
                    connectionStatus.textContent = '‚úÖ Conectado';
                    connectionStatus.classList.add('connected');
                });

                socket.on('disconnect', () => {
                    console.log('‚ùå Desconectado do WebSocket');
                    connectionStatus.textContent = '‚ùå Desconectado';
                    connectionStatus.classList.remove('connected');
                });

                socket.on('new-drop', (dropData) => {
                    console.log('üéâ Novo drop recebido via WebSocket:', dropData);
                    showNewDropNotification(dropData);
                    
                    // Adicionar o novo drop √† lista
                    drops.unshift(dropData);
                    renderDrops();
                });

                socket.on('drop-deleted', (dropId) => {
                    console.log('üóëÔ∏è Drop removido:', dropId);
                    // Remover drop da lista
                    drops = drops.filter(drop => drop.id !== dropId);
                    renderDrops();
                });

            } catch (error) {
                console.error('‚ùå Erro ao conectar WebSocket:', error);
            }
        }

        // Mostrar notifica√ß√£o de novo drop
        function showNewDropNotification(dropData) {
            const notification = document.createElement('div');
            notification.className = 'drop-notification';
            notification.innerHTML = `
                <strong>üéÅ NOVO DROP!</strong>
                <p>üë§ ${dropData.username}</p>
                <p>ü™ô ${dropData.robux} Robux</p>
                <small>${new Date().toLocaleTimeString()}</small>
            `;
            
            document.body.appendChild(notification);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function setupEventListeners() {
            // Login com Discord
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    if (user) {
                        logout();
                    } else {
                        loginModal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    }
                });
            }

            // Modal login button
            if (modalLoginBtn) {
                modalLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginWithDiscord();
                });
            }
        }

        // Configurar fechamento de modais
        function setupModalClosing() {
            // Fechar modais ao clicar fora
            document.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    loginModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                if (e.target === errorModal) {
                    errorModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });

            // Fechar modais com tecla ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    loginModal.style.display = 'none';
                    errorModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });

            // Bot√£o de fechar no modal de erro
            if (errorCloseBtn) {
                errorCloseBtn.addEventListener('click', () => {
                    errorModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });
            }
        }

        // Configurar menu mobile
        function setupMobileMenu() {
            if (mobileMenuBtn && filters) {
                mobileMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    filters.classList.toggle('active');
                });

                // Fechar menu ao clicar fora
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.filters') && !e.target.closest('.mobile-menu-btn')) {
                        filters.classList.remove('active');
                    }
                });

                // Fechar menu ao redimensionar para desktop
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 768) {
                        filters.classList.remove('active');
                    }
                });
            }
        }

        // Configurar bot√µes de copiar
        function setupCopyButtons() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('copy-btn')) {
                    const value = e.target.getAttribute('data-value');
                    copyToClipboard(value, e.target);
                }
            });
        }

        // Configurar filtros
        function setupFilters() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const filter = btn.dataset.filter;
                    renderDrops(filter);
                    
                    // Fechar menu mobile ap√≥s sele√ß√£o
                    if (window.innerWidth <= 768) {
                        filters.classList.remove('active');
                    }
                });
            });
        }

        // Fun√ß√£o para copiar para a √°rea de transfer√™ncia
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                // Feedback visual
                const originalText = button.textContent;
                button.textContent = '‚úì Copiado!';
                button.style.background = '#00C853';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                showError('Erro ao copiar. Tente novamente.');
            });
        }

        // Verificar se o usu√°rio est√° autenticado
        function checkAuth() {
            const token = localStorage.getItem('discord_token');
            const userData = localStorage.getItem('discord_user');
            const rolesData = localStorage.getItem('discord_roles');
            
            if (token && userData) {
                user = JSON.parse(userData);
                if (rolesData) userRoles = JSON.parse(rolesData);
                
                if (userRoles.length > 0) {
                    updateUIAfterLogin();
                    loadDrops();
                } else {
                    // Tentar obter as roles novamente
                    checkUserRoles(token);
                }
            } else {
                // Mostrar estado n√£o autenticado
                showNoAccessMessage();
            }
        }

        // Login com Discord OAuth2
        function loginWithDiscord() {
            const authUrl = `${BACKEND_URL}/auth/discord`;
            window.location.href = authUrl;
        }

        // Processar resposta de autentica√ß√£o
        function processAuthResponse() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const error = urlParams.get('error');
            
            if (error) {
                showError("Erro ao fazer login. Tente novamente.");
                // Limpar par√¢metros da URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (token) {
                localStorage.setItem('discord_token', token);
                getUserInfo(token);
                
                // Limpar par√¢metros da URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Obter informa√ß√µes do usu√°rio
        async function getUserInfo(token) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/user-info`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (!data.canAccess) {
                        showError("Voc√™ precisa ser membro do servidor para acessar os drops.");
                        logout();
                        return;
                    }
                    
                    user = {
                        id: data.userId,
                        username: data.username,
                        avatar: data.avatar
                    };
                    
                    userRoles = data.roles;
                    user.isVip = data.isVip;
                    user.isMember = data.isMember;
                    
                    localStorage.setItem('discord_user', JSON.stringify(user));
                    localStorage.setItem('discord_roles', JSON.stringify(userRoles));
                    
                    updateUIAfterLogin();
                    loadDrops();
                    
                } else if (response.status === 403) {
                    showError("Voc√™ precisa ser membro do servidor para acessar os drops.");
                    logout();
                } else {
                    throw new Error('Falha ao obter informa√ß√µes do usu√°rio');
                }
            } catch (error) {
                console.error('Erro:', error);
                showError("Erro ao fazer login. Tente novamente.");
                logout();
            }
        }

        // Verificar cargos do usu√°rio no servidor
        async function checkUserRoles(token) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/user-info`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (!data.canAccess) {
                        showError("Voc√™ precisa ser membro do servidor para acessar os drops.");
                        logout();
                        return;
                    }
                    
                    userRoles = data.roles;
                    user.isVip = data.isVip;
                    user.isMember = data.isMember;
                    
                    localStorage.setItem('discord_roles', JSON.stringify(userRoles));
                    updateUIAfterLogin();
                    loadDrops();
                    
                } else if (response.status === 403) {
                    showError("Voc√™ precisa ser membro do servidor para acessar os drops.");
                    logout();
                } else {
                    throw new Error('Falha ao verificar cargos');
                }
            } catch (error) {
                console.error('Erro ao verificar cargos:', error);
                showError("Erro ao verificar permiss√µes. Tente novamente.");
                logout();
            }
        }

        // Atualizar UI ap√≥s login
        function updateUIAfterLogin() {
            loginBtn.textContent = 'Sair';
            if (user.avatar) {
                userAvatar.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=128`;
            }
            username.textContent = user.username;
            userInfo.classList.remove('hidden');
            loginModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Logout
        function logout() {
            localStorage.removeItem('discord_token');
            localStorage.removeItem('discord_user');
            localStorage.removeItem('discord_roles');
            user = null;
            userRoles = [];
            loginBtn.textContent = 'Entrar com Discord';
            userInfo.classList.add('hidden');
            clearDrops();
            showNoAccessMessage();
            
            // Desconectar WebSocket se estiver conectado
            if (socket) {
                socket.disconnect();
                connectionStatus.textContent = '‚ùå Desconectado';
                connectionStatus.classList.remove('connected');
            }
        }

        // Mostrar erro
        function showError(message) {
            if (errorMessage) {
                errorMessage.textContent = message;
            }
            if (errorModal) {
                errorModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        // Carregar drops DO BACKEND (ATUALIZADO)
async function loadDrops() {
    try {
        const token = localStorage.getItem('discord_token');
        
        if (!token) {
            showNoAccessMessage();
            return;
        }

        const response = await fetch(`${BACKEND_URL}/api/drops`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                drops = data.drops;
            } else {
                drops = [];
            }
        } else {
            console.error('Erro ao carregar drops:', response.status);
            drops = [];
        }
    } catch (error) {
        console.error('Erro ao carregar drops:', error);
        drops = [];
    }
    
    renderDrops();
}

        // Renderizar drops
        function renderDrops(filter = 'all') {
            clearDrops();
            
            if (!user || userRoles.length === 0) {
                showNoAccessMessage();
                return;
            }
            
            const canSeeVip = userRoles.includes(VIP_ROLE_ID) || userRoles.includes(OWNER_ROLE_ID);
            const isOwner = userRoles.includes(OWNER_ROLE_ID);
            
            let filteredDrops = drops;
            
            if (filter === 'normal') {
                filteredDrops = drops.filter(drop => !drop.isVip);
            } else if (filter === 'vip') {
                filteredDrops = drops.filter(drop => drop.isVip);
                if (!canSeeVip) {
                    filteredDrops = [];
                    showNoDropsMessage(filter);
                    return;
                }
            }
            
            if (filteredDrops.length === 0) {
                showNoDropsMessage(filter);
                return;
            }
            
            filteredDrops.forEach(drop => {
                const dropElement = createRobloxAccountElement(drop, isOwner);
                dropsGrid.appendChild(dropElement);
            });
        }

        // Criar elemento de card para conta Roblox
        function createRobloxAccountElement(account, isOwner) {
            const card = document.createElement('div');
            card.className = 'drop-card';
            card.dataset.id = account.id;
            
            const isVipOnly = account.isVip;
            
            card.innerHTML = `
                ${isVipOnly ? '<div class="vip-badge">VIP</div>' : '<div class="drop-badge">ROBLOX</div>'}
                <img src="${account.imageUrl}" alt="${account.username}" class="drop-image">
                <div class="drop-content">
                    <h3 class="drop-title">${account.username}</h3>
                    <div class="drop-price">${account.robux} Robux ‚Ä¢ ${account.age}</div>
                    
                    <ul class="drop-features">
                        ${account.features.map(feature => `<li>${feature}</li>`).join('')}
                    </ul>
                    
                    <div class="account-credentials">
                        <div class="credential-item">
                            <span>Usu√°rio: </span>
                            <span class="credential-value">${account.username}</span>
                            <button class="copy-btn" data-value="${account.username}">Copiar</button>
                        </div>
                        
                        <div class="credential-item">
                            <span>Senha: </span>
                            <span class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button class="copy-btn" data-value="${account.password}">Copiar</button>
                        </div>
                        
                        <div class="credential-item">
                            <span>Cookie: </span>
                            <span class="credential-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button class="copy-btn" data-value="${account.cookie}">Copiar</button>
                        </div>
                    </div>
                    
                    <p class="drop-description">${account.description}</p>
                    
                    <div class="drop-footer">
                        <button class="claim-btn">Resgatar Agora</button>
                        ${isOwner ? '<button class="delete-btn">üóëÔ∏è</button>' : ''}
                    </div>
                </div>
            `;
            
            const claimBtn = card.querySelector('.claim-btn');
            claimBtn.addEventListener('click', () => {
                alert(`Voc√™ est√° resgatando a conta: ${account.username}\n${account.robux} Robux`);
            });
            
            if (isOwner) {
                const deleteBtn = card.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', () => {
                    if (confirm(`Tem certeza que deseja deletar a conta "${account.username}"?`)) {
                        deleteDrop(account.id);
                    }
                });
            }
            
            return card;
        }

        // Deletar drop (ATUALIZADO)
async function deleteDrop(dropId) {
    try {
        const token = localStorage.getItem('discord_token');
        const response = await fetch(`${BACKEND_URL}/api/drops/${dropId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Atualizar a lista local
                drops = drops.filter(drop => drop.id !== dropId);
                renderDrops();
            } else {
                showError('Erro ao deletar drop');
            }
        } else {
            showError('Erro ao deletar drop');
        }
    } catch (error) {
        console.error('Erro ao deletar drop:', error);
        showError('Erro ao deletar conta');
    }
}

        // Limpar drops
        function clearDrops() {
            dropsGrid.innerHTML = '';
        }

        // Mostrar mensagem quando n√£o h√° acesso
        function showNoAccessMessage() {
            dropsGrid.innerHTML = `
                <div class="no-drops">
                    <h3>Acesso Restrito</h3>
                    <p>Voc√™ precisa ser membro do servidor para visualizar os drops.</p>
                    <button class="login-btn" style="margin-top: 15px;">Entrar com Discord</button>
                </div>
            `;
            
            const loginBtn = dropsGrid.querySelector('.login-btn');
            loginBtn.addEventListener('click', () => {
                if (loginModal) {
                    loginModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            });
        }

        // Mostrar mensagem quando n√£o h√° drops
        function showNoDropsMessage(filter = 'all') {
            let message = '';
            if (filter === 'vip') {
                message = '<p>Voc√™ precisa ser VIP para visualizar as contas VIP.</p>';
            } else {
                message = '<p>Volte mais tarde para ver novidades!</p>';
            }
            
            dropsGrid.innerHTML = `
                <div class="no-drops">
                    <h3>Nenhuma conta dispon√≠vel no momento</h3>
                    ${message}
                </div>
            `;
        }
    </script>
</body>
</html>
